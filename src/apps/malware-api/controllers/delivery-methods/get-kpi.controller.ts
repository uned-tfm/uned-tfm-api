import { ExpressController } from '../express-controller';
import { NextFunction, Request, Response } from 'express';
import { isNil } from '../../../../contexts/shared/utils/type-checkers';
import { BadRequest } from '../../errors/http-error';
import { OK } from 'http-status-codes';
import {
  findDeliveryMethodByCountry,
  findDeliveryMethodByFileType,
  findDeliveryMethodByMalwareType
} from '../../dependencies/use-cases/delivery-methods';
import { DeliveryMethodByCountryMapper } from '../../mappers/delivery-methods/delivery-method-by-country.mapper';
import { DeliveryMethodByFileTypeMapper } from '../../mappers/delivery-methods/delivery-method-by-file-type.mapper';
import { DeliveryMethodByMalwareTypeMapper } from '../../mappers/delivery-methods/delivery-method-by-malware-type.mapper';

export class FindDeliveryMethodKPIController extends ExpressController {
  protected async implementation(req: Request, res: Response, next: NextFunction): Promise<void> {
    if (isNil(req.query) || isNil(req.query.operation)) {
      return next(BadRequest('The query params are not valid'));
    }

    switch (req.query.operation) {
      case 'count-by-country':
        return this.processCountByCountryOperation(req, res, next);
      case 'count-by-file-type':
        return this.processCountByFileTypeeOperation(req, res, next);
      case 'count-by-malware-type':
        return this.processCountByMalwareTypeOperation(req, res, next);
      default:
        return next(BadRequest('The operation is not valid'));
    }
  }

  private async processCountByCountryOperation(
    req: Request,
    res: Response,
    next: NextFunction
  ): Promise<void> {
    const result = await findDeliveryMethodByCountry();
    const data = result.map(DeliveryMethodByCountryMapper.toDTO);
    res.status(OK).send(data);
  }

  private async processCountByFileTypeeOperation(
    req: Request,
    res: Response,
    next: NextFunction
  ): Promise<void> {
    const result = await findDeliveryMethodByFileType();
    const data = result.map(DeliveryMethodByFileTypeMapper.toDTO);
    res.status(OK).send(data);
  }

  private async processCountByMalwareTypeOperation(
    req: Request,
    res: Response,
    next: NextFunction
  ): Promise<void> {
    const result = await findDeliveryMethodByMalwareType();
    const data = result.map(DeliveryMethodByMalwareTypeMapper.toDTO);
    res.status(OK).send(data);
  }
}
